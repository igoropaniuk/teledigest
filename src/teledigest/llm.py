from __future__ import annotations

import datetime as dt
import openai
from .config import log, OPENAI_API_KEY, TIMEZONE

openai.api_key = OPENAI_API_KEY


def build_prompt(day: dt.date, messages):
    if not messages:
        return (
            "You are a helpful assistant.",
            f"No messages to summarize for {day.isoformat()}.",
        )

    lines = []
    max_items = 500
    max_chars_per_msg = 500

    for channel, text in messages[:max_items]:
        t = " ".join(text.split())
        if not t:
            continue
        if len(t) > max_chars_per_msg:
            t = t[:max_chars_per_msg] + " ..."
        lines.append(f"[{channel}] {t}")

    corpus = "\n".join(lines)

    system = (
        "–¢–∏ ‚Äî –∞—Å–∏—Å—Ç–µ–Ω—Ç, —è–∫–∏–π –∞–Ω–∞–ª—ñ–∑—É—î –Ω–æ–≤–∏–Ω–∏ —Ç–∞ –∫–ª–∞—Å–∏—Ñ—ñ–∫—É—î —ó—Ö —É —Ñ–æ—Ä–º–∞—Ç—ñ ¬´–∑—Ä–∞–¥–∞ / –ø–µ—Ä–µ–º–æ–≥–∞ / –Ω–µ –≤—Å–µ —Ç–∞–∫ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ¬ª. "
        "–¢–∏ –æ—Ç—Ä–∏–º—É—î—à –±–∞–≥–∞—Ç–æ —Ç–≤—ñ—Ç—ñ–≤ –∑ —Ä—ñ–∑–Ω–∏—Ö –¥–∂–µ—Ä–µ–ª. "
        "–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞—Ç–∏ —ó—Ö —É —Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:\n\n"
        "1. –ó–†–ê–î–ê ‚Äî –ø–æ–≥–∞–Ω—ñ –Ω–æ–≤–∏–Ω–∏, –Ω–µ–≥–∞—Ç–∏–≤–Ω—ñ –Ω–∞—Å–ª—ñ–¥–∫–∏, –Ω–µ–≤–¥–∞—á—ñ, –ø—Ä–æ–≥—Ä–∞—à—ñ, –≤—Ç—Ä–∞—Ç–∏, –∫–æ—Ä—É–ø—Ü—ñ—è, —Å–∫–∞–Ω–¥–∞–ª–∏, –∑–∞–≥—Ä–æ–∑–∏.\n"
        "2. –ü–ï–†–ï–ú–û–ì–ê ‚Äî —Ö–æ—Ä–æ—à—ñ –Ω–æ–≤–∏–Ω–∏, —É—Å–ø—ñ—Ö–∏, –ø—Ä–æ–≥—Ä–µ—Å, –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è, –∑–¥–æ–±—É—Ç–∫–∏, –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ –∑—Ä—É—à–µ–Ω–Ω—è.\n"
        "3. –ù–ï –í–°–ï –¢–ê–ö –û–î–ù–û–ó–ù–ê–ß–ù–û ‚Äî —Å–∫–ª–∞–¥–Ω—ñ, –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ñ –∞–±–æ –∑–º—ñ—à–∞–Ω—ñ –ø–æ–¥—ñ—ó; —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è, —è–∫—É –≤–∞–∂–∫–æ –≤—ñ–¥–Ω–µ—Å—Ç–∏ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –¥–æ –ø–æ–∑–∏—Ç–∏–≤—É —á–∏ –Ω–µ–≥–∞—Ç–∏–≤—É; "
        "—Å—É–ø–µ—Ä–µ—á–ª–∏–≤—ñ –æ—Ü—ñ–Ω–∫–∏ –∞–±–æ —Å–∏—Ç—É–∞—Ü—ñ—ó –∑ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ —Ä—ñ–∑–Ω–∏–º–∏ —Ç—Ä–∞–∫—Ç—É–≤–∞–Ω–Ω—è–º–∏.\n\n"
        "–ì–æ–ª–æ–≤–Ω–µ: –ß—ñ—Ç–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é, –Ω–µ –≤–∏–≥–∞–¥—É–π —Ñ–∞–∫—Ç—ñ–≤, –Ω–µ –ø–µ—Ä–µ–∫—Ä—É—á—É–π –∑–º—ñ—Å—Ç. "
        "–û–±‚Äô—î–¥–Ω—É–π —Å—Ö–æ–∂—ñ —Ç–≤—ñ—Ç–∏ –≤ –æ–¥–∏–Ω –ø—É–Ω–∫—Ç."
    )

    user = f"""
        –°—å–æ–≥–æ–¥–Ω—ñ {day.isoformat()} —É —á–∞—Å–æ–≤–æ–º—É –ø–æ—è—Å—ñ {TIMEZONE}.

        –ù–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–æ —Ç–≤—ñ—Ç–∏ –∑ —Ä—ñ–∑–Ω–∏—Ö Telegram-–∞–∫–∞—É–Ω—Ç—ñ–≤:

        {corpus}

        –ó–∞–≤–¥–∞–Ω–Ω—è:

        1. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –≤—Å—ñ —Ç–≤—ñ—Ç–∏ –π —Ä–æ–∑–ø–æ–¥—ñ–ª–∏ —ó—Ö –Ω–∞ —Ç—Ä–∏ —Å–µ–∫—Ü—ñ—ó:
        - üü• **–ó–†–ê–î–ê**
        - üü© **–ü–ï–†–ï–ú–û–ì–ê**
        - üü® **–ù–ï –í–°–ï –¢–ê–ö –û–î–ù–û–ó–ù–ê–ß–ù–û**

        2. –£ –∫–æ–∂–Ω—ñ–π —Å–µ–∫—Ü—ñ—ó —Å—Ç–≤–æ—Ä–∏ —Å–ø–∏—Å–æ–∫ –º–∞—Ä–∫–æ–≤–∞–Ω–∏—Ö –ø—É–Ω–∫—Ç—ñ–≤:
        - –ö–æ–∂–µ–Ω –ø—É–Ω–∫—Ç –ø–æ–≤–∏–Ω–µ–Ω –æ–±‚Äô—î–¥–Ω—É–≤–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ —Å—Ö–æ–∂–∏—Ö —Ç–≤—ñ—Ç—ñ–≤ (—è–∫—â–æ –≤–æ–Ω–∏ –ø—Ä–æ –æ–¥–Ω–µ –π —Ç–µ —Å–∞–º–µ), –ø–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –µ–º–æ–¥–∑—ñ.
        - –í–∫–∞–∑—É–π —Ñ–∞–∫—Ç–∏ –∫–æ—Ä–æ—Ç–∫–æ, —á—ñ—Ç–∫–æ, –±–µ–∑ –æ—Ü—ñ–Ω–æ—á–Ω–∏—Ö —Å—É–¥–∂–µ–Ω—å.

        3. –ù–∞–ø—Ä–∏–∫—ñ–Ω—Ü—ñ –¥–æ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π (2‚Äì3 —Ä–µ—á–µ–Ω–Ω—è) –∑–∞–≥–∞–ª—å–Ω–∏–π –ø—ñ–¥—Å—É–º–æ–∫ –¥–Ω—è.
        4. –ó–æ—Å–µ—Ä–µ–¥—å—Å—è –≤–∏–∫–ª—é—á–Ω–æ –Ω–∞ –≤–∞–∂–ª–∏–≤–∏—Ö –Ω–æ–≤–∏–Ω–∞—Ö, —â–æ —Å—Ç–æ—Å—É—é—Ç—å—Å—è –£–∫—Ä–∞—ó–Ω–∏ —Ç–∞ –≥–µ–æ–ø–æ–ª—ñ—Ç–∏–∫–∏ –π –º–æ–∂—É—Ç—å –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –≤—ñ–π–Ω—É –ø—Ä–æ—Ç–∏ –£–∫—Ä–∞—ó–Ω–∏;
        —ñ–≥–Ω–æ—Ä—É–π —É—Å—ñ —ñ–Ω—à—ñ –Ω–æ–≤–∏–Ω–∏. –¢–∞–∫–æ–∂ —ñ–≥–Ω–æ—Ä—É–π –º–µ–º–∏, –¥—Ä—ñ–±–Ω—É –±–∞–ª–∞–∫–∞–Ω–∏–Ω—É, —Ä–µ–∫–ª–∞–º—É —Ç–∞ —Ç–µ–º–∏, –ø–æ–≤‚Äô—è–∑–∞–Ω—ñ –∑ –æ—Å–æ–±–∏—Å—Ç–∏–º –∑–¥–æ—Ä–æ–≤‚Äô—è–º.

        –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Markdown (–∂–æ–¥–Ω–∏—Ö #, *, ``` —Ç–æ—â–æ).
        –§–æ—Ä–º–∞—Ç –≤–∏–≤–æ–¥—É: —Ç—ñ–ª—å–∫–∏ Telegram HTML.
        –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ç–µ–≥–∏ <b>, <i>, <u>, <code>, <a href='‚Ä¶'> —Ç–∞ —Å–∏–º–≤–æ–ª ‚Ä¢ –¥–ª—è —Å–ø–∏—Å–∫—ñ–≤.
        –£—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é —ñ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –Ω–µ –±—ñ–ª—å—à–µ 2000 —Å–∏–º–≤–æ–ª—ñ–≤.
        Reply should be only in Ukrainian and less than 2000 symbols.
        –§–æ—Ä–º–∞—Ç —Å—É–≤–æ—Ä–æ –∑ —Ä–æ–∑–¥—ñ–ª–∞–º–∏:

        –°—å–æ–≥–æ–¥–Ω—ñ {day.isoformat()}.

        <b> üü• –ó–†–ê–î–ê </b>
        - –ø—É–Ω–∫—Ç
        - –ø—É–Ω–∫—Ç

        <b> üü© –ü–ï–†–ï–ú–û–ì–ê </b>
        - –ø—É–Ω–∫—Ç
        - –ø—É–Ω–∫—Ç

        <b> üü® –ù–ï –í–°–ï –¢–ê–ö –û–î–ù–û–ó–ù–ê–ß–ù–û </b>
        - –ø—É–Ω–∫—Ç
        - –ø—É–Ω–∫—Ç

        <b> ‚úÖ –ü—ñ–¥—Å—É–º–æ–∫ –¥–Ω—è </b>
        2‚Äì3 —Ä–µ—á–µ–Ω–Ω—è

        <b> –†—ñ–≤–µ–Ω—å –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ - –¢—É—Ç –Ω–∞–¥–∞–π —á–∏—Å–ª–æ –≤—ñ–¥ 0 –¥–æ 100% —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Ä—ñ–≤–Ω—é –ø–æ–∑–∏—Ç–∏–≤—É (–ø–æ–∑–∏—Ç–∏–≤–Ω–∏—Ö –Ω–æ–≤–∏—Ö –ø–æ –≤—ñ–¥–Ω–æ—à–µ–Ω–Ω—é –¥–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–∏—Ö) —ñ –µ–º–æ–¥–∑—ñ (üòÄ - –Ω–∏–∂—á–µ 100%, üôÇ - –Ω–∏–∂—á–µ 80%, üòê - –Ω–∏–∂—á–µ 50%, üòß - –Ω–∏–∂—á–µ 30%) </b>

        """

    return system, user


def strip_markdown_fence(text: str) -> str:
    """
    If the text is wrapped in ```...``` or ```markdown ... ```,
    remove those outer fences so Telegram can render it as Markdown.
    """
    if not text:
        return text

    stripped = text.strip()
    if not stripped.startswith("```"):
        return text

    lines = stripped.splitlines()

    # drop first line if it's ``` or ```markdown
    first = lines[0].strip()
    if first.startswith("```"):
        lines = lines[1:]

    # drop last line if it's ```
    if lines and lines[-1].strip() == "```":
        lines = lines[:-1]

    return "\n".join(lines).strip()


def llm_summarize(day: dt.date, messages):
    system, user = build_prompt(day, messages)
    log.info("Calling OpenAI for summary (%d messages)...", len(messages))

    try:
        response = openai.ChatCompletion.create(
            model="gpt-5.1",
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": user},
            ],
            temperature=0.4,
        )
        summary = response.choices[0].message["content"].strip()
        summary = strip_markdown_fence(summary)
        log.info("Received summary from OpenAI (%d chars).", len(summary))
        return summary
    except Exception as e:
        log.exception("OpenAI API error: %s", e)
        return f"Failed to generate AI summary for {day.isoformat()}.\n\n" f"Error: {e}"
